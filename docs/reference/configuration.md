Configuration
# Configuration 
This reference provides an in-depth guide to configuring Scanio's core and plugin settings. It explains how to use YAML configuration files and environment variables for dynamic setups, outlines core directives, plugin-specific configurations, and operational modes, and details the initialization and priority mechanisms. 

**Placeholder Conventions** <br>
In this documentation, we use the following conventions for placeholders:
- `{}`: Represents values derived from configuration directives or user-defined settings.
- `<>`: Represents values dynamically generated by the tool during runtime.

## Table of contents
- [What is a Configuration File?](#what-is-a-configuration-file)
  - [Configuration Initialization Process](#configuration-initialization-process)
  - [Configuration Priority](#configuration-priority)
  - [Environment Variables in Configuration File](#environment-variables-in-configuration-file)
- [Core Configuration](#core-configuration)
  - [Configuration File](#configuration-file)
    - [Scanio Settings Directive](#scanio-settings-directive)
    - [Logger Settings Directive](#logger-settings-directive)
  - [Environment Variables](#environment-variables)
- [Plugins Configuration](#plugins-configuration)
  - [Common Plugin Configuration](#common-plugin-configuration)
    - [Git Client Configuration](#git-client-configuration)
    - [HTTP Client Configuration](#http-client-configuration)
    - [Supported Common Directives by Plugins](#supported-common-directives-by-plugins)
  - [Plugin-Specific Configurations](#plugin-specific-configurations)
    - [Trufflehog3 Plugin](#trufflehog3-plugin)
    - [CodeQL Plugin](#codeql-plugin)
- [Modes](#modes)
  - [User Mode](#user-mode)
  - [CI Mode](#ci-mode)


## What is a Configuration File?
A configuration file in Scanio allows users to define all settings in a single structured YAML file. This file supports directives for both the core Scanio system and its plugins. It is flexible, customizable, and many options can also be overridden with environment variables for dynamic adjustments.

You can find a complete example of a Scanio configuration file, listing all possible directives, in [config_example.yml](../../config_example.yml).

### Configuration Initialization Process
The configuration file is located and initialized using the following process:
- Environment Variable `SCANIO_CONFIG_PATH`: Scanio first checks if the environment variable `SCANIO_CONFIG_PATH` is set. If set, Scanio attempts to load the configuration from the specified path.
- Default Paths: If `SCANIO_CONFIG_PATH` is not set, Scanio searches in the following default paths:
    - `~/.scanio/config.yml` (Local installation default path)
    - `/scanio/config.yml` (Docker container default path)
* Default Configuration: If no configuration file is found in the above locations, Scanio uses the default configuration, which is defined in [config.go](../../pkg/shared/config/config.go).

**Example Usage**
```bash
export SCANIO_CONFIG_PATH=/home/config.yml
```
The core validates the path and loads the specified file as the configuration.

### Configuration Priority
Scanio resolves settings in the following order:
- Environment Variables: Highest priority.
- Configuration Files: Secondary priority.
- Default Values: Used if no other configuration is provided.

### Environment Variables in Configuration File
Scanio supports using environment variables as dynamic placeholders in configuration files. If a directive includes an environment variable in the format `{$ENV_NAME}`, its value will be resolved during runtime initialization. This allows to keep secrets undiclosed in repository or on a disk.

> [!IMPORTANT]  
> This allows sensitive information, such as secrets, to remain secure and not be exposed in repositories.

**Example Configuration** 
```yaml
github_plugin:
  token: "{$GIT_TOKEN}"
```

```bash
export GIT_TOKEN=my-token-example
```

**Result**  
The configuration resolves `github_plugin.token` to `my-token-example`.

## Core Configuration
### Configuration File
The core configuration in Scanio includes directives that govern general behavior and control the operational aspects of the tool.

#### Scanio Settings Directive
The `scanio` directive defines the overall structure and storage locations for Scanio and can be customized based on deployment environments. These directives define paths, modes, and logging behavior for the system.


| Directive         | Default Value              | Description                                                                                                 |
|--------------------|----------------------------|-------------------------------------------------------------------------------------------------------------|
| `mode`            | `user`                    | Specifies the operating mode of Scanio. Supported values: `user`, `CI`. For further details, see [Modes](#modes).                                    |
| `home_folder`     | `~/.scanio/`              | Root directory for all Scanio operations. If unset, defaults to the user's home directory appended with `.scanio`.    |
| `plugins_folder`  | `{home_folder}/plugins`   | Directory for Scanio plugins and metadata.                    |
| `projects_folder` | `{home_folder}/projects`  | Directory for project-specific files, organized by VCS domain, namespace, and repository.                               |
| `results_folder`  | `{home_folder}/results`   | Directory for scan results, organized hierarchically by VCS domain, namespace, and repository.             |
| `temp_folder`     | `{home_folder}/tmp`       | Directory for temporary files, such as files from PR scans.               |

> [!IMPORTANT]  
>  It is recommended to use the default behavior and avoid changing folder-related directives unless necessary.

For detailed folder structures, refer to [Folder Structure and Usage](scanio.md#folder-structure-and-usage).

####  Logger Settings Directive
The `logger` directive configures logging behavior for Scanio. Logger settings are propagate to all plugins, ensuring a consistent logging experience across the entire system..


| Directive       | Default Value | Description                                                                                       |
|------------------|---------------|---------------------------------------------------------------------------------------------------|
| `level`          | `info`        | Sets the logging [verbosity](https://pkg.go.dev/github.com/hashicorp/go-hclog#Logger). Supported values: `debug`, `info`, `warn`, `error`, `trace`.         |
| `disable_time`   | `true`        | Disables [timestamps](https://pkg.go.dev/github.com/hashicorp/go-hclog#LoggerOptions) in logs.                                                                     |
| `json_format`    | `false`       | [Formats](https://pkg.go.dev/github.com/hashicorp/go-hclog#LoggerOptions) logs as JSON if enabled.                                                                |
| `include_location` | `false`    | Includes file and line number [information](https://pkg.go.dev/github.com/hashicorp/go-hclog#LoggerOptions) in log entries.                                        |


### Environment Variables
Scanio supports a range of environment variables for configuring core functionality. 

| Environment Variable     | Maps to Directive    | Default Value        | Description                                                                                       |
|---------------------------|----------------------|----------------------|---------------------------------------------------------------------------------------------------|
| `SCANIO_CONFIG_PATH`      | N/A                 | `none`                 | Specifies the path to the configuration file. Overrides the default search paths. For details, see [Configuration Initialization Process](#configuration-initialization-process).                 |
| `SCANIO_MODE`             | `mode`              | `user`               | Determines the operating mode of Scanio (`user` or `CI`).                                         |
| `CI`                      | N/A              | `false`              | If set to `true`, enforces CI mode for integration with CI/CD pipelines.                         |
| `SCANIO_HOME`             | `home_folder`       | `~/.scanio/`         | Overrides the default home folder for Scanio.                                                    |
| `SCANIO_PLUGINS_FOLDER`   | `plugins_folder`    | `{home_folder}/plugins` | Overrides the directory for storing Scanio plugins.                                              |
| `SCANIO_PROJECTS_FOLDER`  | `projects_folder`   | `{home_folder}/projects` | Overrides the directory for storing project-specific files.                                      |
| `SCANIO_RESULTS_FOLDER`   | `results_folder`    | `{home_folder}/results` | Overrides the directory for storing scan results.                                                |
| `SCANIO_TEMP_FOLDER`      | `temp_folder`       | `{home_folder}/tmp`  | Overrides the directory for temporary files.                                                     |
| `SCANIO_LOG_LEVEL`        | `logger.level`      | `info`               | Sets the logging verbosity level. Supported values: `DEBUG`, `INFO`, `WARN`, `ERROR`, `TRACE`.   |

## Plugins Configuration
Scanio supports various plugins, each with its own specific configuration directives. Additionally, some plugins share common configuration options to simplify setup and management.

### Common Plugin Configuration
#### Git Client Configuration
The `git_client` directive configures Git-related operations for plugins, enabling users to set options for cloning, timeouts, and TLS settings.

| Directive       | Default Value  | Description                                                                                             |
|------------------|----------------|---------------------------------------------------------------------------------------------------------|
| `depth`         | `0`            | Depth for Git clones. A value of `0` performs a full clone, useful for searching secrets in Git history.|
| `insecure_tls`  | `false`        | Disables TLS certificate verification.                                               |
| `timeout`       | `10m`          | Maximum duration for Git operations before timing out.                             |


#### HTTP Client Configuration
The `http_client` directive manages HTTP request behavior for plugins, allowing users to configure retries, timeouts, TLS settings, and proxy options.

| Directive               | Default Value     | Description                                                                                             |
|--------------------------|-------------------|---------------------------------------------------------------------------------------------------------|
| `retry_count`           | `5`              | Number of retries for HTTP requests.                                                                   |
| `retry_wait_time`       | `1s`             | Time to wait before retrying an HTTP request.                                                          |
| `retry_max_wait_time`   | `5s`             | Maximum time to wait before retrying an HTTP request.                                  |
| `timeout`               | `10s`            | Timeout for HTTP requests.                                                            |
| `tls_client_config.verify` | `true`        | Whether to verify TLS certificates.                                                     |
| `proxy.host`            | `none`           | Proxy server address. If a scheme is unspecified, defaults to `http://`.                             |
| `proxy.port`            | `none`           | Proxy server port.                                                              |
| `custom_headers`        | `none`           | Custom headers to add to each HTTP request (e.g., `Authorization`).                     |

> [!CAUTION]
> Custom headers will be added to every HTTP request made by any tool or plugin that supports the `http_client` directive.

#### Supported Common Directives by Plugins
Not all plugins support or require shared configuration directives. For instance, the Semgrep plugin does not actively participate in sending HTTP requests or fetching code, so it does not utilize `http_client` or `git_client`.

| Plugin Name  | HTTP Client Configuration | Git Client Configuration    |
|:-------------|:--------------------------|:----------------------------|
| GitHub       | ✅                        | ✅                           |
| GitLab       | ✅                        | ✅                           |
| Bitbucket    | ✅                        | ✅                           |
| Semgrep      | ❌                        | ❌                           |
| CodeQL       | ❌                        | ❌                           |
| Bandit       | ❌                        | ❌                           |
| Trufflehog   | ❌                        | ❌                           |
| Trufflehog3  | ❌                        | ❌                           |

### Plugin-Specific Configurations
Refer to plugin-specific documentation for detailed examples:
- [GitHub Plugin: Configuration References](plugin-github.md#configuration-references)
- [GitLab Plugin: Configuration References](plugin-gitlab.md#configuration-references)
- [Bitbucket Plugin: Configuration References](plugin-bitbucket.md#configuration-references)

#### Trufflehog3 Plugin
##### Configuration File
The Trufflehog3 plugin enables Scanio to scan repositories for secrets using [Trufflehog3](https://github.com/feeltheajf/trufflehog3). This plugin uses the `trufflehog3_plugin` directive, which supports the following settings.

| Directive                          | Default Value | Description                                                                                              |
|------------------------------------|---------------|----------------------------------------------------------------------------------------------------------|
| `write_default_trufflehog_config_if_missing` | `true`        | Creates a [default `.trufflehog3.yml`](../../plugins/trufflehog3/internal/config.go#37) configuration file if it does not already exist in the target directory. |
| `force_overwrite_trufflehog_config`         | `false`       | Overwrites existing `.trufflehog3.yml` files with [default `.trufflehog3.yml`](../../plugins/trufflehog3/internal/config.go#37) configuration if set to `true`.                |
| `exclude_paths`                    |     `none`       | List of paths to exclude from scanning, added to the exclusion section of the `.trufflehog3.yml` file.   |

#### CodeQL Plugin
##### Configuration File
The CodeQL plugin allows Scanio to perform static code analysis using CodeQL databases. This plugin uses the `codeql_plugin` directive, which supports the following setting.

| Directive       | Default Value | Description                                                                                              |
|------------------|---------------|----------------------------------------------------------------------------------------------------------|
| `db_language`   | `""`          | Specifies the language for building a CodeQL database.                                                  |


##### Environment variables
The CodeQL plugin supports the following environment variable, which can override the configuration file setting.

| Environment Variable           | Maps to Directive  | Description                                                                                              |
|---------------------------------|--------------------|----------------------------------------------------------------------------------------------------------|
| `SCANIO_CODEQL_DB_LANGUAGE`    | `db_language`      | Specifies the language for CodeQL database building. Overrides the `db_language` directive.             |

## Modes
Scanio operates in two primary modes: **User Mode** and **CI Mode**. Each mode alters specific aspects of Scanio's behavior to optimize for its environment.

### User Mode
In **User Mode**, Scanio operates with a focus on local development or manual usage. This mode is ideal for:
- Developers running scans on their local machines.
- Security engineers performing ad hoc scans or audits.


### CI Mode
In **CI Mode**, Scanio adapts its behavior for integration with Continuous Integration/Continuous Deployment (CI/CD) pipelines. The following adjustments are applied:

### Mode-Specific Behaviors
#### Result Output
Results are written to `stdout` to simplify parsing in CI pipelines. This eliminates the need to search for generated files in runtime directories.

The results are presented in a JSON structure for easy integration:
```json
{
  "launches": [
    {
      "args": {
        ...
      },
      "result": {
        ...
      },
      "status": "",
      "message": ""
    }
  ]
}
```

For detailed specifications, refer to [here](../../pkg/shared/common.go#42).

#### Default Rule Sets
The Semgrep Plugin uses different default rule sets based on the mode:
- User Mode: Default rule set is `p/default`.
- CI Mode: Default rule set is `p/ci`.

#### Report Naming
- User Mode: Templates follow the structure `scanio-report-<plugin_name>.<report_ext>`.
- CI Mode: Templates include a timestamp for uniqueness: `scanio-report-<current_time.RFC3339>-<plugin_name>.<report_ext>`.

#### Logging Behavior
Log files differ in naming and location:
- User Mode: Logs are named `<command>_<plugin_name>`.
- CI Mode: Logs include a timestamp for uniqueness: `<command>_<plugin_name>_<current_time.RFC3339>`.
Logs are stored in `{home_folder}/logs by default`.

#### Command-Specific Adjustments
For the `to-html` command, the `-s` (Source Folder) flag is ignored in CI Mode.